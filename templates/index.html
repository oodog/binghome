<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>BingHome</title>
<style>
  :root{
    --accent:#107C10; /* Xbox green */
    --accent2:#005FB8; /* MS blue */
    --glass: rgba(0,0,0,.35);
    --glass2: rgba(255,255,255,.08);
  }
  html,body{height:100%;margin:0;font-family:Segoe UI,Arial,sans-serif;background:#0a0a0a;color:#fff;overflow:hidden}
  .bg{
    position:fixed; inset:0;
    background:url('{{ img_url }}') center/cover no-repeat;
    filter:brightness(.65) saturate(1.1);
  }
  .scrim{position:fixed; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.65))}
  .wrap{position:relative; z-index:2; height:100%; display:flex; flex-direction:column}
  .topbar{display:flex; justify-content:space-between; align-items:center; padding:18px 24px}
  .brand{font-size:22px; font-weight:600; letter-spacing:.3px}
  .brand span{opacity:.8; font-weight:400}
  .barbtn a{color:#fff; text-decoration:none; padding:10px 16px; border-radius:12px; background:var(--glass); border:1px solid rgba(255,255,255,.15)}
  .grid{
    flex:1; display:grid; gap:14px; padding:14px 24px 24px;
    grid-template-columns: repeat(12, 1fr);
    grid-auto-rows: 110px;
  }
  .tile{
    position:relative;
    background: var(--glass);
    border:1px solid rgba(255,255,255,.18);
    border-radius:18px;
    backdrop-filter: blur(10px);
    box-shadow: 0 10px 30px rgba(0,0,0,.25) inset, 0 0 0 1px rgba(255,255,255,.04);
    overflow:hidden;
    cursor:pointer;
    transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .tile:hover{ transform: translateY(-2px); background: rgba(0,0,0,.42) }
  .tile .hdr{display:flex; align-items:center; gap:10px; padding:14px 16px; font-weight:600}
  .badge{font-size:12px; opacity:.8}
  .big{font-size:36px; font-weight:700; padding:0 16px 12px}
  .row{display:flex; gap:8px; padding:0 16px 14px; flex-wrap:wrap}
  .chip{padding:8px 12px; border-radius:10px; background:var(--glass2); border:1px solid rgba(255,255,255,.12); font-size:14px}
  .accent{outline:2px solid var(--accent); box-shadow:0 0 0 2px rgba(16,124,16,.3) inset}
  .accent2{outline:2px solid var(--accent2); box-shadow:0 0 0 2px rgba(0,95,184,.28) inset}
  .tile:active{transform:translateY(0)}
  /* sizes reminiscent of Xbox dashboard */
  .w6{grid-column: span 6}
  .w4{grid-column: span 4}
  .w3{grid-column: span 3}
  .w2{grid-column: span 2}
  .h2{grid-row: span 2}
  .footer{padding:10px 18px; opacity:.75}
  /* voice mic */
  .mic{
    position:fixed; right:24px; bottom:24px; z-index:10;
    width:70px; height:70px; border-radius:50%;
    background: radial-gradient(120px 120px at 50% 50%, rgba(16,124,16,.5), rgba(0,0,0,.6));
    border:1px solid rgba(255,255,255,.2);
    display:flex; align-items:center; justify-content:center;
    backdrop-filter: blur(6px);
    cursor:pointer; transition: transform .12s ease;
  }
  .mic:hover{ transform: scale(1.05) }
  .pulse{ animation: p 1.4s ease-in-out infinite }
  @keyframes p { 0%,100%{transform:scale(1)} 50%{transform:scale(1.06)} }
  /* responsive */
  @media (max-width: 1100px){ .grid{grid-template-columns: repeat(8,1fr)} }
  @media (max-width: 760px){ .grid{grid-template-columns: repeat(4,1fr); grid-auto-rows: 95px} .big{font-size:28px}}
</style>
</head>
<body>
<div class="bg"></div>
<div class="scrim"></div>

<div class="wrap">
  <div class="topbar">
    <div class="brand">Bing<span>Home</span></div>
    <div class="barbtn">
      <a href="/settings">Settings</a>
    </div>
  </div>

  <div class="grid">
    <!-- Hero tile: date/time + weather placeholder (hook up later) -->
    <div class="tile h2 w6 accent" onclick="window.location='/settings/system_status'">
      <div class="hdr">üìä System</div>
      <div class="big" id="clock">--:--</div>
      <div class="row">
        <div class="chip" id="chipTemp">Temp: --</div>
        <div class="chip" id="chipHum">Humidity: --</div>
        <div class="chip">CPU/Memory</div>
      </div>
    </div>

    <!-- Home Assistant quick actions -->
    <div class="tile h2 w3 accent2" onclick="haQuick('light','turn_on',{'entity_id':'light.living_room'})">
      <div class="hdr">üí° Lights</div>
      <div class="big">Living Room On</div>
      <div class="row"><div class="chip">Tap to toggle</div></div>
    </div>

    <div class="tile h2 w3" onclick="haQuick('light','turn_off',{'entity_id':'light.living_room'})">
      <div class="hdr">üåô Lights</div>
      <div class="big">All Off</div>
      <div class="row"><div class="chip">Goodnight</div></div>
    </div>

    <div class="tile w4 h2" onclick="haQuick('scene','turn_on',{'entity_id':'scene.movie_time'})">
      <div class="hdr">üé¨ Scene</div>
      <div class="big">Movie Time</div>
      <div class="row"><div class="chip">Dim + TV + Strip</div></div>
    </div>

    <div class="tile w4 h2" onclick="haQuick('climate','set_temperature',{'entity_id':'climate.home','temperature':23})">
      <div class="hdr">‚ùÑÔ∏è Climate</div>
      <div class="big">Set 23¬∞C</div>
      <div class="row"><div class="chip">Cooling</div></div>
    </div>

    <div class="tile w4 h2" onclick="window.location='/settings/wifi'">
      <div class="hdr">üì∂ Network</div>
      <div class="big">Wi-Fi</div>
      <div class="row"><div class="chip">Scan & Connect</div></div>
    </div>

    <!-- Sensors summary -->
    <div class="tile w3" onclick="refreshSensors()">
      <div class="hdr">üå°Ô∏è Temperature</div>
      <div class="big" id="tTemp">--¬∞C</div>
    </div>

    <div class="tile w3" onclick="refreshSensors()">
      <div class="hdr">üíß Humidity</div>
      <div class="big" id="tHum">--%</div>
    </div>

    <div class="tile w3" onclick="refreshSensors()">
      <div class="hdr">üü¢ Gas</div>
      <div class="big" id="tGas">--</div>
    </div>

    <div class="tile w3" onclick="refreshSensors()">
      <div class="hdr">üîÜ Light</div>
      <div class="big" id="tLight">--</div>
    </div>
  </div>

  <div class="footer">Tap mic to speak. Try: ‚Äúturn on living room lights‚Äù or ‚Äúset temperature to 23‚Äù.</div>
</div>

<!-- Voice button -->
<div class="mic pulse" id="micBtn" title="Hold to talk">üé§</div>

<script>
  // clock + sensor chips
  function tick(){
    const d=new Date(), hh=d.getHours().toString().padStart(2,'0'), mm=d.getMinutes().toString().padStart(2,'0');
    document.getElementById('clock').textContent=`${hh}:${mm}`;
  }
  setInterval(tick,1000); tick();

  async function refreshSensors(){
    try{
      const r=await fetch('/api/sensor_data'); const j=await r.json();
      document.getElementById('chipTemp').textContent = 'Temp: ' + (j.temperature!=null? j.temperature+'¬∞C':'--');
      document.getElementById('chipHum').textContent = 'Humidity: ' + (j.humidity!=null? j.humidity+'%':'--');
      document.getElementById('tTemp').textContent = (j.temperature!=null? j.temperature+'¬∞C':'--');
      document.getElementById('tHum').textContent = (j.humidity!=null? j.humidity+'%':'--');
      document.getElementById('tGas').textContent = j.gas_detected? 'DETECTED':'Clear';
      document.getElementById('tLight').textContent = j.light_detected? 'BRIGHT':'Dark';
    }catch(e){ console.log(e); }
  }
  refreshSensors(); setInterval(refreshSensors,15000);

  // HA quick action buttons
  async function haQuick(domain, service, payload){
    try{
      const r = await fetch('/api/ha/service',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({domain,service,payload})});
      const j = await r.json();
      if(!j.success) alert('HA error: ' + (j.info||'unknown'));
    }catch(e){ alert('HA error'); }
  }

  // Push-to-talk (press & hold)
  let mediaRecorder, chunks=[];
  const mic = document.getElementById('micBtn');
  let holding=false, startHold=0;

  async function setupStream(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
      mediaRecorder.ondataavailable = e => { if (e.data.size>0) chunks.push(e.data); };
      mediaRecorder.onstop = sendAudio;
    }catch(e){ alert('Mic not available: ' + e.message); }
  }
  setupStream();

  mic.addEventListener('mousedown', startRec);
  mic.addEventListener('touchstart', startRec);
  mic.addEventListener('mouseup', stopRec);
  mic.addEventListener('mouseleave', cancelIfHolding);
  mic.addEventListener('touchend', stopRec);

  function startRec(e){
    e.preventDefault(); if(!mediaRecorder) return;
    holding=true; startHold=Date.now(); chunks=[];
    try{ mediaRecorder.start(); mic.classList.add('pulse'); }catch(_){}
  }
  function stopRec(e){
    e.preventDefault();
    if(!holding) return;
    holding=false;
    try{ mediaRecorder.stop(); }catch(_){}
  }
  function cancelIfHolding(){ if(holding){ holding=false; try{ mediaRecorder.stop(); }catch(_){} } }

  async function sendAudio(){
    if(chunks.length===0) return;
    const blob = new Blob(chunks, {type:'audio/webm'});
    const fd = new FormData(); fd.append('audio', blob, 'voice.webm');
    try{
      const r = await fetch('/api/voice', { method:'POST', body: fd });
      const j = await r.json();
      if(!j.success) {
        console.log(j);
        alert(j.error || j.result || 'Didn‚Äôt catch that.');
      }
    }catch(e){ alert('Voice failed'); }
    chunks=[];
  }
</script>
</body>
</html>
