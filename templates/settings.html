<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BingHome - Settings</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .back-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        h1 { color: #00ff88; }
        .settings-section {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .settings-section h2 {
            color: #00ff88;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            color: #fff;
        }
        .btn {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }
        .btn:hover { background: #00cc66; }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        .quick-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .link-btn {
            background: rgba(255,255,255,0.1);
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .link-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        .api-status {
            font-size: 12px;
            color: #00ff88;
            margin-left: 10px;
        }
        .status-message {
            padding: 10px;
            margin: 20px 0;
            border-radius: 5px;
            display: none;
        }
        .status-message.show {
            display: block;
        }
        .status-message.success {
            background: rgba(0,255,136,0.2);
            border: 1px solid #00ff88;
        }
        .status-message.error {
            background: rgba(255,68,68,0.2);
            border: 1px solid #ff4444;
        }
        .weather-preview {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        .weather-source-info {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            margin: 10px 0;
        }
        .toggle-switch input {
            display: none;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background: #00ff88;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/" class="back-btn">‚Üê Back</a>
        <h1>Settings</h1>
    </div>

    <div id="statusMessage" class="status-message"></div>

    <div class="settings-section">
        <h2>üîó Quick Access</h2>
        <div class="quick-links">
            <a href="/wifi" class="link-btn">üì∂ WiFi Settings</a>
            <a href="/bluetooth" class="link-btn">üî∑ Bluetooth</a>
            <a href="/camera-settings" class="link-btn">üì∑ Camera Settings</a>
            <a href="/security-cameras" class="link-btn">üìπ Security Cameras</a>
            <a href="/system" class="link-btn">üìä System Status</a>
            <a href="#" onclick="checkHealth()" class="link-btn">‚ù§Ô∏è Health Check</a>
            <a href="#" onclick="restartSystem()" class="link-btn">üîÑ Restart</a>
        </div>
    </div>

    <div class="settings-section">
        <h2>üå§Ô∏è Weather Configuration</h2>
        <div class="form-group">
            <label>Weather Data Source</label>
            <select id="weatherSource" onchange="updateWeatherSourceInfo()">
                <option value="openweather">OpenWeatherMap (Global)</option>
                <option value="qld_radar">Queensland Radar (Australia)</option>
                <option value="bom_australia">Bureau of Meteorology (Australia)</option>
            </select>
            <div class="weather-source-info" id="weatherSourceInfo">
                Select a weather source to see configuration options
            </div>
        </div>
        
        <div class="form-group" id="weatherLocationGroup">
            <label>Location</label>
            <input type="text" id="weatherLocation" placeholder="e.g., Gold Coast, QLD or Sydney, NSW">
            <div style="font-size: 12px; color: #888; margin-top: 5px;">
                Enter city name, or "City, State" or "City, Country" for better results
            </div>
        </div>
        
        <div class="form-group" id="weatherApiGroup">
            <label>
                OpenWeatherMap API Key
                <span class="api-status" id="weatherApiStatus"></span>
            </label>
            <input type="password" id="weatherApiKey" placeholder="Your OpenWeatherMap API key">
            <div style="font-size: 12px; color: #888; margin-top: 5px;">
                Get free API key at <a href="https://openweathermap.org/api" target="_blank" style="color: #00ff88;">openweathermap.org/api</a>
            </div>
        </div>
        
        <div class="weather-preview" id="weatherPreview" style="display: none;">
            <h4>Weather Preview</h4>
            <div id="weatherPreviewContent">Loading...</div>
        </div>
        
        <div class="form-group">
            <button class="btn btn-secondary" onclick="testWeatherConfig()">Test Weather</button>
        </div>
    </div>

    <div class="settings-section">
        <h2>ÔøΩÔ∏è Sensor Calibration</h2>
        <div class="form-group">
            <label>Temperature Calibration Offset (¬∞C)</label>
            <input type="number" id="tempOffset" step="0.1" placeholder="0.0">
            <div style="font-size: 12px; color: #888; margin-top: 5px;">
                If your sensor reads high, enter a negative value (e.g., -6 if it reads 32¬∞C but should be 26¬∞C)
            </div>
        </div>
        <div class="form-group">
            <div id="currentTempDisplay" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 5px;">
                <div style="font-size: 14px; color: #888; margin-bottom: 5px;">Current Reading:</div>
                <div style="font-size: 24px; color: #00ff88;" id="rawTemp">--¬∞C</div>
                <div style="font-size: 14px; color: #888; margin-top: 10px;">After Calibration:</div>
                <div style="font-size: 24px; color: #fff;" id="calibratedTemp">--¬∞C</div>
            </div>
        </div>
        <div class="form-group">
            <button class="btn btn-secondary" onclick="refreshSensorData()">Refresh Sensor Data</button>
        </div>
    </div>

    <div class="settings-section">
        <h2>ÔøΩüé§ Voice Control</h2>
        <div class="form-group">
            <label>Voice Provider</label>
            <select id="voiceProvider">
                <option value="local">Local (Offline)</option>
                <option value="openai">OpenAI Whisper</option>
                <option value="google">Google Cloud</option>
                <option value="azure">Azure Speech</option>
            </select>
        </div>
        <div class="form-group">
            <label>Wake Words (comma separated)</label>
            <input type="text" id="wakeWords" value="hey bing, okay bing">
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" id="voiceEnabled"> Enable Voice Control
            </label>
        </div>
    </div>

    <div class="settings-section">
        <h2>üîë API Keys</h2>
        <div class="form-group">
            <label>
                OpenAI API Key
                <span class="api-status" id="openaiStatus"></span>
            </label>
            <input type="password" id="openaiKey" placeholder="sk-...">
        </div>
        <div class="form-group">
            <label>
                Bing News API Key
                <span class="api-status" id="bingStatus"></span>
            </label>
            <input type="password" id="bingKey" placeholder="Your Bing API key">
        </div>
        <div class="form-group">
            <label>Home Assistant URL</label>
            <input type="text" id="haUrl" value="http://localhost:8123">
        </div>
        <div class="form-group">
            <label>
                Home Assistant Token
                <span class="api-status" id="haStatus"></span>
            </label>
            <input type="password" id="haToken" placeholder="Long-lived access token">
        </div>
    </div>

    <div class="settings-section">
        <h2>üì∑ Google Photos Integration</h2>

        <!-- Shared Album (Easy Method) -->
        <div class="form-group">
            <label>Shared Album Link (Easiest - No Sign-in Required)</label>
            <input type="text" id="sharedAlbumUrl" placeholder="https://photos.app.goo.gl/xxxxx">
            <div style="font-size: 12px; color: #888; margin-top: 5px;">
                Paste a shared Google Photos album link. The album must have "Anyone with the link can view" permission.
            </div>
        </div>
        <div class="form-group">
            <button class="btn btn-secondary" onclick="testSharedAlbum()">Test Shared Album</button>
            <span id="sharedAlbumStatus" style="margin-left: 10px; font-size: 12px;"></span>
        </div>

        <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0; padding-top: 20px;">
            <div style="font-size: 12px; color: #888; margin-bottom: 10px;">OR use OAuth (Advanced - requires Google Cloud setup)</div>
        </div>

        <div class="form-group">
            <label>OAuth Status</label>
            <div id="googlePhotosStatus" style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                <span id="photosStatusText">Not connected</span>
            </div>
        </div>
        <div class="form-group" id="photosSignInSection">
            <button class="btn btn-secondary" onclick="signInToGooglePhotos()">Sign in with Google (Advanced)</button>
        </div>
        <div class="form-group" id="albumSelectionSection" style="display: none;">
            <label>Select Album for Slideshow</label>
            <select id="googlePhotosAlbum">
                <option value="">Loading albums...</option>
            </select>
        </div>
        <div class="form-group">
            <label>Slideshow Interval: <span id="intervalDisplay">10 seconds</span></label>
            <input type="range" id="photosIntervalSlider" min="0" max="7" value="2"
                   style="width: 100%; margin: 10px 0;" onchange="updateIntervalDisplay()">
            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #888;">
                <span>2s</span>
                <span>5s</span>
                <span>10s</span>
                <span>15s</span>
                <span>20s</span>
                <span>30s</span>
                <span>45s</span>
                <span>60s</span>
            </div>
            <input type="hidden" id="photosInterval" value="10">
        </div>
        <div class="form-group" id="photosActionsSection" style="display: none;">
            <button class="btn btn-secondary" onclick="refreshAlbums()">Refresh Albums</button>
            <button class="btn btn-secondary" onclick="disconnectGooglePhotos()">Disconnect OAuth</button>
        </div>
    </div>

    <div class="settings-section">
        <h2>ÔøΩüì± Applications</h2>
        <div class="form-row">
            <div class="form-group">
                <label>Netflix URL</label>
                <input type="text" id="netflixUrl" value="https://www.netflix.com">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="netflixEnabled" checked> Enable Netflix
                </label>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>YouTube URL</label>
                <input type="text" id="youtubeUrl" value="https://www.youtube.com/tv">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="youtubeEnabled" checked> Enable YouTube
                </label>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>Spotify URL</label>
                <input type="text" id="spotifyUrl" value="https://open.spotify.com">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="spotifyEnabled" checked> Enable Spotify
                </label>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>Xbox Cloud Gaming URL</label>
                <input type="text" id="xboxUrl" value="https://www.xbox.com/play">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="xboxEnabled" checked> Enable Xbox
                </label>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>Prime Video URL</label>
                <input type="text" id="primeUrl" value="https://www.primevideo.com">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="primeEnabled" checked> Enable Prime Video
                </label>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>Google Photos URL</label>
                <input type="text" id="photosUrl" value="https://photos.google.com">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="photosEnabled" checked> Enable Google Photos
                </label>
            </div>
        </div>
    </div>

    <div class="settings-section">
        <h2>üè† System</h2>
        <div class="form-group">
            <label>
                <input type="checkbox" id="kioskMode"> Enable Kiosk Mode
            </label>
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" id="autoStart"> Auto-start Browser
            </label>
        </div>
        <div class="form-group">
            <label>Display Timeout (minutes)</label>
            <select id="displayTimeout">
                <option value="0">Never</option>
                <option value="5">5 minutes</option>
                <option value="10">10 minutes</option>
                <option value="30">30 minutes</option>
                <option value="60">1 hour</option>
            </select>
        </div>
    </div>

    <div style="margin-top: 30px;">
        <button class="btn" onclick="saveSettings()">Save Settings</button>
        <button class="btn btn-secondary" onclick="testSettings()">Test Connection</button>
    </div>

    <script>
        let currentSettings = {};

        // Slideshow interval mapping: slider position -> seconds
        const intervalValues = [2, 5, 10, 15, 20, 30, 45, 60];

        function updateIntervalDisplay() {
            const slider = document.getElementById('photosIntervalSlider');
            const display = document.getElementById('intervalDisplay');
            const hiddenInput = document.getElementById('photosInterval');

            if (!slider || !display || !hiddenInput) return;

            const seconds = intervalValues[slider.value] || 10;
            display.textContent = seconds + ' seconds';
            hiddenInput.value = seconds;
        }

        function setIntervalFromValue(seconds) {
            const slider = document.getElementById('photosIntervalSlider');
            if (!slider) {
                console.log('Slider not found');
                return;
            }

            // Find closest match in intervalValues
            let closestIndex = 2; // default to 10 seconds (index 2)
            let closestDiff = Math.abs(intervalValues[0] - seconds);

            for (let i = 0; i < intervalValues.length; i++) {
                const diff = Math.abs(intervalValues[i] - seconds);
                if (diff < closestDiff) {
                    closestDiff = diff;
                    closestIndex = i;
                }
            }

            slider.value = closestIndex;
            updateIntervalDisplay();
        }

        window.onload = function() {
            loadSettings();
        };

        // Helper to safely set element value
        function setVal(id, value) {
            const el = document.getElementById(id);
            if (el) el.value = value;
        }

        // Helper to safely set checkbox
        function setCheck(id, checked) {
            const el = document.getElementById(id);
            if (el) el.checked = checked;
        }

        // Helper to safely set text content
        function setText(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }

        function loadSettings() {
            fetch('/api/settings')
                .then(r => r.json())
                .then(settings => {
                    try {
                        currentSettings = settings;
                        console.log('Loaded settings:', settings);

                        // Sensor calibration
                        setVal('tempOffset', settings.temp_offset || 0);

                        // Google Photos - Shared Album URL
                        setVal('sharedAlbumUrl', settings.google_photos_shared_url || '');

                        // Slideshow interval
                        setIntervalFromValue(settings.google_photos_interval || 10);

                        // Google Photos OAuth
                        if (typeof loadGooglePhotosStatus === 'function') {
                            loadGooglePhotosStatus(settings);
                        }

                        // Voice settings
                        setVal('voiceProvider', settings.voice_provider || 'local');
                        setVal('wakeWords', (settings.wake_words || ['hey bing', 'okay bing']).join(', '));
                        setCheck('voiceEnabled', settings.voice_enabled !== false);

                        // Weather settings
                        setVal('weatherSource', settings.weather_source || 'openweather');
                        setVal('weatherLocation', settings.weather_location || 'Gold Coast, QLD');
                        if (typeof updateWeatherSourceInfo === 'function') {
                            updateWeatherSourceInfo();
                        }

                        // API Keys - Show status if configured
                        if (settings.openai_api_key_configured || settings.openai_api_key) {
                            setText('openaiStatus', '(configured)');
                        }
                        if (settings.weather_api_key_configured || settings.weather_api_key) {
                            setText('weatherApiStatus', '(configured)');
                        }
                        if (settings.bing_api_key_configured || settings.bing_api_key) {
                            setText('bingStatus', '(configured)');
                        }
                        if (settings.home_assistant_token_configured || settings.home_assistant_token) {
                            setText('haStatus', '(configured)');
                        }

                        // Home Assistant URL
                        setVal('haUrl', settings.home_assistant_url || 'http://localhost:8123');

                        // Apps settings
                        const apps = settings.apps || {};
                        setVal('netflixUrl', apps.netflix?.url || 'https://www.netflix.com');
                        setCheck('netflixEnabled', apps.netflix?.enabled !== false);

                        setVal('youtubeUrl', apps.youtube?.url || 'https://www.youtube.com/tv');
                        setCheck('youtubeEnabled', apps.youtube?.enabled !== false);

                        setVal('spotifyUrl', apps.spotify?.url || 'https://open.spotify.com');
                        setCheck('spotifyEnabled', apps.spotify?.enabled !== false);

                        setVal('xboxUrl', apps.xbox_cloud?.url || 'https://www.xbox.com/play');
                        setCheck('xboxEnabled', apps.xbox_cloud?.enabled !== false);

                        setVal('primeUrl', apps.prime_video?.url || 'https://www.primevideo.com');
                        setCheck('primeEnabled', apps.prime_video?.enabled !== false);

                        setVal('photosUrl', apps.google_photos?.url || 'https://photos.google.com');
                        setCheck('photosEnabled', apps.google_photos?.enabled !== false);

                        // System settings
                        setCheck('kioskMode', settings.kiosk_mode || false);
                        setCheck('autoStart', settings.auto_start_browser || false);
                        setVal('displayTimeout', settings.display_timeout || '0');

                        console.log('Settings loaded successfully');
                    } catch (innerErr) {
                        console.error('Error applying settings:', innerErr);
                    }
                })
                .catch(err => {
                    console.error('Error fetching settings:', err);
                    showMessage('Error loading settings', 'error');
                });
        }

        function updateWeatherSourceInfo() {
            const source = document.getElementById('weatherSource').value;
            const infoEl = document.getElementById('weatherSourceInfo');
            const locationGroup = document.getElementById('weatherLocationGroup');
            const apiGroup = document.getElementById('weatherApiGroup');
            
            switch(source) {
                case 'openweather':
                    infoEl.innerHTML = 'üåç Global weather data with detailed forecasts. Requires free API key.';
                    locationGroup.style.display = 'block';
                    apiGroup.style.display = 'block';
                    break;
                case 'qld_radar':
                    infoEl.innerHTML = 'üá¶üá∫ Queensland-specific radar with live precipitation data. No API key required.';
                    locationGroup.style.display = 'none';
                    apiGroup.style.display = 'none';
                    break;
                case 'bom_australia':
                    infoEl.innerHTML = 'üá¶üá∫ Australian Bureau of Meteorology data. No API key required.';
                    locationGroup.style.display = 'block';
                    apiGroup.style.display = 'none';
                    break;
            }
        }

        function testWeatherConfig() {
            const source = document.getElementById('weatherSource').value;
            const location = document.getElementById('weatherLocation').value;
            const apiKey = document.getElementById('weatherApiKey').value;
            
            showMessage('Testing weather configuration...', 'success');
            
            // Create test settings
            const testSettings = {
                weather_source: source,
                weather_location: location
            };
            
            if (apiKey) {
                testSettings.weather_api_key = apiKey;
            }
            
            fetch('/api/weather/test', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(testSettings)
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('weatherPreview').style.display = 'block';
                    document.getElementById('weatherPreviewContent').innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 24px; font-weight: bold;">${data.current.temp}¬∞C</div>
                                <div>${data.current.description}</div>
                                <div style="font-size: 12px; opacity: 0.7;">${data.current.location}</div>
                            </div>
                            <div style="text-align: right;">
                                <div>üíß ${data.current.humidity}%</div>
                                <div>üå™Ô∏è ${data.current.wind_speed} km/h</div>
                                ${data.current.radar_available ? '<div>üì° Radar Available</div>' : ''}
                            </div>
                        </div>
                    `;
                    showMessage('Weather test successful!', 'success');
                } else {
                    showMessage('Weather test failed: ' + (data.error || 'Unknown error'), 'error');
                    document.getElementById('weatherPreview').style.display = 'none';
                }
            })
            .catch(err => {
                showMessage('Weather test failed', 'error');
                document.getElementById('weatherPreview').style.display = 'none';
            });
        }

        function testSharedAlbum() {
            const url = document.getElementById('sharedAlbumUrl').value;
            const statusEl = document.getElementById('sharedAlbumStatus');

            if (!url) {
                statusEl.innerHTML = '<span style="color: #ff4444;">Please enter a shared album URL</span>';
                return;
            }

            statusEl.innerHTML = '<span style="color: #00ff88;">Testing...</span>';

            fetch('/api/google_photos/shared/test', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url: url})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    statusEl.innerHTML = `<span style="color: #00ff88;">‚úì Found ${data.count} photos!</span>`;
                    showMessage('Shared album working! Save settings to use it.', 'success');
                } else {
                    statusEl.innerHTML = `<span style="color: #ff4444;">‚úó ${data.error || 'Could not access album'}</span>`;
                }
            })
            .catch(err => {
                statusEl.innerHTML = `<span style="color: #ff4444;">‚úó Test failed</span>`;
            });
        }

        function saveSettings() {
            const settings = {
                // Sensor calibration
                temp_offset: parseFloat(document.getElementById('tempOffset').value) || 0,

                // Google Photos settings
                google_photos_shared_url: document.getElementById('sharedAlbumUrl').value || '',
                google_photos_album: document.getElementById('googlePhotosAlbum') ? document.getElementById('googlePhotosAlbum').value : '',
                google_photos_interval: document.getElementById('photosInterval') ? parseInt(document.getElementById('photosInterval').value) : 10,
                
                // Voice settings
                voice_provider: document.getElementById('voiceProvider').value,
                wake_words: document.getElementById('wakeWords').value.split(',').map(w => w.trim()),
                voice_enabled: document.getElementById('voiceEnabled').checked,
                
                // Weather settings
                weather_source: document.getElementById('weatherSource').value,
                weather_location: document.getElementById('weatherLocation').value,
                
                // Home Assistant
                home_assistant_url: document.getElementById('haUrl').value,
                
                // System settings
                kiosk_mode: document.getElementById('kioskMode').checked,
                auto_start_browser: document.getElementById('autoStart').checked,
                display_timeout: parseInt(document.getElementById('displayTimeout').value),
                
                // Apps
                apps: {
                    netflix: {
                        url: document.getElementById('netflixUrl').value,
                        enabled: document.getElementById('netflixEnabled').checked
                    },
                    youtube: {
                        url: document.getElementById('youtubeUrl').value,
                        enabled: document.getElementById('youtubeEnabled').checked
                    },
                    spotify: {
                        url: document.getElementById('spotifyUrl').value,
                        enabled: document.getElementById('spotifyEnabled').checked
                    },
                    xbox_cloud: {
                        url: document.getElementById('xboxUrl').value,
                        enabled: document.getElementById('xboxEnabled').checked
                    },
                    prime_video: {
                        url: document.getElementById('primeUrl').value,
                        enabled: document.getElementById('primeEnabled').checked
                    },
                    google_photos: {
                        url: document.getElementById('photosUrl').value,
                        enabled: document.getElementById('photosEnabled').checked
                    }
                }
            };
            
            // Only update API keys if new values are entered
            const openaiKey = document.getElementById('openaiKey').value;
            if (openaiKey && openaiKey !== '') {
                settings.openai_api_key = openaiKey;
            }
            
            const weatherKey = document.getElementById('weatherApiKey').value;
            if (weatherKey && weatherKey !== '') {
                settings.weather_api_key = weatherKey;
            }
            
            const bingKey = document.getElementById('bingKey').value;
            if (bingKey && bingKey !== '') {
                settings.bing_api_key = bingKey;
            }
            
            const haToken = document.getElementById('haToken').value;
            if (haToken && haToken !== '') {
                settings.home_assistant_token = haToken;
            }

            console.log('Saving settings:', settings);

            fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(settings)
            })
            .then(r => r.json())
            .then(data => {
                console.log('Save response:', data);
                if (data.success) {
                    showMessage('Settings saved successfully!', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to save'), 'error');
                }
            })
            .catch(err => {
                console.error('Save error:', err);
                showMessage('Error saving settings', 'error');
            });
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('statusMessage');
            messageDiv.textContent = message;
            messageDiv.className = 'status-message show ' + type;
            
            setTimeout(() => {
                messageDiv.className = 'status-message';
            }, 5000);
        }

        function checkHealth() {
            fetch('/api/health')
                .then(r => r.json())
                .then(data => {
                    showMessage('System Status: ' + data.status + ' | Version: ' + (data.version || '2.1.0'), 'success');
                })
                .catch(err => showMessage('Health check failed', 'error'));
        }

        function restartSystem() {
            if (confirm('Restart BingHome system?')) {
                fetch('/api/restart', {method: 'POST'})
                    .then(r => r.json())
                    .then(data => showMessage(data.message || 'Restarting...', 'success'))
                    .catch(err => showMessage('Restart failed', 'error'));
            }
        }

        function testSettings() {
            checkHealth();
            testWeatherConfig();
        }

        function refreshSensorData() {
            fetch('/api/sensor_data')
                .then(r => r.json())
                .then(data => {
                    const rawTemp = data.temperature;
                    const offset = parseFloat(document.getElementById('tempOffset').value) || 0;
                    const calibratedTemp = rawTemp !== null ? (rawTemp + offset).toFixed(1) : '--';
                    
                    document.getElementById('rawTemp').textContent = rawTemp !== null ? rawTemp.toFixed(1) + '¬∞C' : '--¬∞C';
                    document.getElementById('calibratedTemp').textContent = calibratedTemp + '¬∞C';
                    
                    showMessage('Sensor data refreshed', 'success');
                })
                .catch(err => {
                    showMessage('Failed to refresh sensor data', 'error');
                });
        }

        // Auto-refresh sensor data on page load and when offset changes
        document.addEventListener('DOMContentLoaded', function() {
            refreshSensorData();
            document.getElementById('tempOffset').addEventListener('input', function() {
                refreshSensorData();
            });
        });

        // Google Photos functions
        function loadGooglePhotosStatus(settings) {
            const connected = settings.google_photos_connected || false;
            const album = settings.google_photos_album || '';
            const interval = settings.google_photos_interval || 10;
            
            if (connected) {
                document.getElementById('photosStatusText').innerHTML = '‚úÖ Connected';
                document.getElementById('photosSignInSection').style.display = 'none';
                document.getElementById('albumSelectionSection').style.display = 'block';
                document.getElementById('albumSettingsSection').style.display = 'block';
                document.getElementById('photosActionsSection').style.display = 'block';
                document.getElementById('photosInterval').value = interval;
                loadAlbums(album);
            } else {
                document.getElementById('photosStatusText').innerHTML = '‚ùå Not connected';
                document.getElementById('photosSignInSection').style.display = 'block';
                document.getElementById('albumSelectionSection').style.display = 'none';
                document.getElementById('albumSettingsSection').style.display = 'none';
                document.getElementById('photosActionsSection').style.display = 'none';
            }
        }

        function signInToGooglePhotos() {
            showMessage('Opening Google Photos authorization...', 'success');
            // Open OAuth flow in new window
            const width = 600;
            const height = 700;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            const authWindow = window.open(
                '/api/google_photos/auth',
                'GooglePhotosAuth',
                `width=${width},height=${height},left=${left},top=${top}`
            );
            
            // Poll for completion
            const checkAuth = setInterval(() => {
                fetch('/api/google_photos/status')
                    .then(r => r.json())
                    .then(data => {
                        if (data.connected) {
                            clearInterval(checkAuth);
                            if (authWindow && !authWindow.closed) {
                                authWindow.close();
                            }
                            showMessage('Google Photos connected successfully!', 'success');
                            location.reload();
                        }
                    })
                    .catch(() => {});
            }, 1000);
            
            // Stop checking after 2 minutes
            setTimeout(() => clearInterval(checkAuth), 120000);
        }

        function loadAlbums(selectedAlbum) {
            fetch('/api/google_photos/albums')
                .then(r => r.json())
                .then(data => {
                    const select = document.getElementById('googlePhotosAlbum');
                    select.innerHTML = '<option value="">-- Select an album --</option>';
                    
                    if (data.success && data.albums) {
                        data.albums.forEach(album => {
                            const option = document.createElement('option');
                            option.value = album.id;
                            option.textContent = `${album.title} (${album.mediaItemsCount || 0} items)`;
                            if (album.id === selectedAlbum) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });
                    }
                })
                .catch(err => {
                    showMessage('Failed to load albums', 'error');
                });
        }

        function refreshAlbums() {
            showMessage('Refreshing albums...', 'success');
            const currentAlbum = document.getElementById('googlePhotosAlbum').value;
            loadAlbums(currentAlbum);
        }

        function disconnectGooglePhotos() {
            if (confirm('Disconnect Google Photos? This will remove access to your photos.')) {
                fetch('/api/google_photos/disconnect', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            showMessage('Google Photos disconnected', 'success');
                            location.reload();
                        } else {
                            showMessage('Failed to disconnect', 'error');
                        }
                    })
                    .catch(() => showMessage('Disconnect failed', 'error'));
            }
        }
    </script>

    <!-- Persistent Home Button -->
    <div onclick="window.location.href='/'" style="
        position: fixed;
        bottom: 15px;
        left: 15px;
        width: 50px;
        height: 50px;
        background: #00ff88;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 9999;
        font-size: 24px;
        box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
    ">üè†</div>
    <!-- Navigation Overlay -->
</body>
</html>
