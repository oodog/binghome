<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>BingHome - Settings</title>
<style>
  body{font-family:Segoe UI,Arial;background:linear-gradient(135deg,#1e1e1e,#2d2d2d);color:#fff;margin:0;min-height:100vh}
  .header{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;background:rgba(0,0,0,.3);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.12)}
  .container{max-width:1100px;margin:0 auto;padding:24px}
  .grid{display:grid;gap:22px;grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
  .card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:18px;backdrop-filter:blur(8px)}
  .card h3{margin:0 0 10px;color:#00d4ff}
  label{display:block;margin:10px 0 6px;opacity:.9}
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);color:#fff}
  .row{display:flex;gap:10px}
  .btn{background:#0078d7;border:none;color:#fff;padding:10px 16px;border-radius:10px;cursor:pointer}
  .btn:disabled{opacity:.6}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;background:#ff4444}
  .dot.ok{background:#44ff44; box-shadow:0 0 8px rgba(68,255,68,.5)}
  .status{opacity:.85}
</style>
</head>
<body>
  <div class="header">
    <h2>Settings</h2>
    <div>
      <a class="btn" href="/">Home</a>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <div class="card">
        <h3>Voice & Assistant</h3>
        <label>Provider</label>
        <select id="provider">
          <option value="openai" {% if cfg.provider=='openai' %}selected{% endif %}>OpenAI (ChatGPT)</option>
          <option value="bing" {% if cfg.provider=='bing' %}selected{% endif %}>Bing (stub)</option>
        </select>

        <label>OpenAI API Key</label>
        <input type="password" id="openai_api_key" placeholder="sk-..." value="{{ cfg.openai_api_key }}"/>

        <label>Model</label>
        <input id="openai_model" value="{{ cfg.openai_model }}"/>

        <label style="display:flex;align-items:center;gap:8px;margin-top:12px">
          <input type="checkbox" id="wake_word" {% if cfg.wake_word_enabled %}checked{% endif %}/>
          Enable wake word (coming soon)
        </label>

        <div style="margin-top:12px">
          <button class="btn" onclick="saveConfig()">Save</button>
          <span class="status" id="saveStatus"></span>
        </div>
      </div>

      <div class="card">
        <h3>Home Assistant</h3>
        <label>Base URL</label>
        <input id="ha_base_url" placeholder="http://localhost:8123" value="{{ cfg.ha_base_url }}"/>

        <label>Long-Lived Access Token</label>
        <input type="password" id="ha_token" placeholder="HA token" value="{{ cfg.ha_token }}"/>

        <div style="margin-top:12px">
          <button class="btn" onclick="testHA()">Test Connection</button>
          <span id="haStatus" class="status"><span class="dot" id="haDot"></span>Not tested</span>
        </div>
      </div>

      <div class="card">
        <h3>Audio</h3>
        <div>Amplifier: <span class="status"><span class="dot {% if audio_available %}ok{% endif %}"></span>{% if audio_available %}Connected{% else %}Not detected{% endif %}</span></div>
        <div style="margin-top:10px;">
          <label>Volume</label>
          <div class="row">
            <button class="btn" onclick="vol(-5)">-</button>
            <input id="vol" type="range" min="0" max="100" value="{{ current_volume }}" oninput="setVol(this.value)" />
            <button class="btn" onclick="vol(5)">+</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Sensors</h3>
        <div class="status">Temp: {{ sensor_data.temperature if sensor_data.temperature != None else '--' }}°C</div>
        <div class="status">Humidity: {{ sensor_data.humidity if sensor_data.humidity != None else '--' }}%</div>
        <div class="status">Gas: {{ 'Detected' if sensor_data.gas_detected else 'Clear' }}</div>
        <div class="status">Light: {{ 'Bright' if sensor_data.light_detected else 'Dark' }}</div>
      </div>
    </div>
  </div>

<script>
async function saveConfig(){
  const body={
    provider: document.getElementById('provider').value,
    openai_api_key: document.getElementById('openai_api_key').value,
    openai_model: document.getElementById('openai_model').value,
    ha_base_url: document.getElementById('ha_base_url').value,
    ha_token: document.getElementById('ha_token').value,
    wake_word_enabled: document.getElementById('wake_word').checked
  };
  document.getElementById('saveStatus').textContent='Saving…';
  const r=await fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  const j=await r.json();
  document.getElementById('saveStatus').textContent = j.success? 'Saved ✅':'Failed ❌';
}

async function testHA(){
  const r=await fetch('/api/ha/service',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({domain:'homeassistant',service:'reload_core_config',payload:{}})});
  const ok = r.ok;
  document.getElementById('haDot').className = 'dot ' + (ok? 'ok':'');
  document.getElementById('haStatus').lastChild.textContent = ok? 'Connected':'Failed';
}

async function vol(delta){
  const ep = delta>0? '/api/volume/up':'/api/volume/down';
  const r = await fetch(ep,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({step:Math.abs(delta)})});
  const j = await r.json();
  document.getElementById('vol').value = j.volume;
}
async function setVol(v){
  await fetch('/api/volume/set',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({volume:parseInt(v)})});
}
</script>
</body>
</html>
