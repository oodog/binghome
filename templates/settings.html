<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BingHome - Settings</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        .back-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }
        h1 { color: #00ff88; }
        .settings-section {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .settings-section h2 {
            color: #00ff88;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            color: #fff;
        }
        .btn {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }
        .btn:hover { background: #00cc66; }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }
        .quick-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .link-btn {
            background: rgba(255,255,255,0.1);
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .link-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        .api-status {
            font-size: 12px;
            color: #00ff88;
            margin-left: 10px;
        }
        .status-message {
            padding: 10px;
            margin: 20px 0;
            border-radius: 5px;
            display: none;
        }
        .status-message.show {
            display: block;
        }
        .status-message.success {
            background: rgba(0,255,136,0.2);
            border: 1px solid #00ff88;
        }
        .status-message.error {
            background: rgba(255,68,68,0.2);
            border: 1px solid #ff4444;
        }
        .weather-preview {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        .weather-source-info {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            margin: 10px 0;
        }
        .toggle-switch input {
            display: none;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background: #00ff88;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-row .form-group {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="/" class="back-btn">‚Üê Back</a>
        <h1>Settings</h1>
    </div>

    <div id="statusMessage" class="status-message"></div>

    <div class="settings-section">
        <h2>üîó Quick Access</h2>
        <div class="quick-links">
            <a href="/wifi" class="link-btn">üì∂ WiFi Settings</a>
            <a href="/system" class="link-btn">üìä System Status</a>
            <a href="#" onclick="checkHealth()" class="link-btn">‚ù§Ô∏è Health Check</a>
            <a href="#" onclick="restartSystem()" class="link-btn">üîÑ Restart</a>
        </div>
    </div>

    <div class="settings-section">
        <h2>üå§Ô∏è Weather Configuration</h2>
        <div class="form-group">
            <label>Weather Data Source</label>
            <select id="weatherSource" onchange="updateWeatherSourceInfo()">
                <option value="openweather">OpenWeatherMap (Global)</option>
                <option value="qld_radar">Queensland Radar (Australia)</option>
                <option value="bom_australia">Bureau of Meteorology (Australia)</option>
            </select>
            <div class="weather-source-info" id="weatherSourceInfo">
                Select a weather source to see configuration options
            </div>
        </div>
        
        <div class="form-group" id="weatherLocationGroup">
            <label>Location</label>
            <input type="text" id="weatherLocation" placeholder="e.g., Gold Coast, QLD or Sydney, NSW">
            <div style="font-size: 12px; color: #888; margin-top: 5px;">
                Enter city name, or "City, State" or "City, Country" for better results
            </div>
        </div>
        
        <div class="form-group" id="weatherApiGroup">
            <label>
                OpenWeatherMap API Key
                <span class="api-status" id="weatherApiStatus"></span>
            </label>
            <input type="password" id="weatherApiKey" placeholder="Your OpenWeatherMap API key">
            <div style="font-size: 12px; color: #888; margin-top: 5px;">
                Get free API key at <a href="https://openweathermap.org/api" target="_blank" style="color: #00ff88;">openweathermap.org/api</a>
            </div>
        </div>
        
        <div class="weather-preview" id="weatherPreview" style="display: none;">
            <h4>Weather Preview</h4>
            <div id="weatherPreviewContent">Loading...</div>
        </div>
        
        <div class="form-group">
            <button class="btn btn-secondary" onclick="testWeatherConfig()">Test Weather</button>
        </div>
    </div>

    <div class="settings-section">
        <h2>üé§ Voice Control</h2>
        <div class="form-group">
            <label>Voice Provider</label>
            <select id="voiceProvider">
                <option value="local">Local (Offline)</option>
                <option value="openai">OpenAI Whisper</option>
                <option value="google">Google Cloud</option>
                <option value="azure">Azure Speech</option>
            </select>
        </div>
        <div class="form-group">
            <label>Wake Words (comma separated)</label>
            <input type="text" id="wakeWords" value="hey bing, okay bing">
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" id="voiceEnabled"> Enable Voice Control
            </label>
        </div>
    </div>

    <div class="settings-section">
        <h2>üîë API Keys</h2>
        <div class="form-group">
            <label>
                OpenAI API Key
                <span class="api-status" id="openaiStatus"></span>
            </label>
            <input type="password" id="openaiKey" placeholder="sk-...">
        </div>
        <div class="form-group">
            <label>
                Bing News API Key
                <span class="api-status" id="bingStatus"></span>
            </label>
            <input type="password" id="bingKey" placeholder="Your Bing API key">
        </div>
        <div class="form-group">
            <label>Home Assistant URL</label>
            <input type="text" id="haUrl" value="http://localhost:8123">
        </div>
        <div class="form-group">
            <label>
                Home Assistant Token
                <span class="api-status" id="haStatus"></span>
            </label>
            <input type="password" id="haToken" placeholder="Long-lived access token">
        </div>
    </div>

    <div class="settings-section">
        <h2>üì± Applications</h2>
        <div class="form-row">
            <div class="form-group">
                <label>Netflix URL</label>
                <input type="text" id="netflixUrl" value="https://www.netflix.com">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="netflixEnabled" checked> Enable Netflix
                </label>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>YouTube URL</label>
                <input type="text" id="youtubeUrl" value="https://www.youtube.com/tv">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="youtubeEnabled" checked> Enable YouTube
                </label>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>Spotify URL</label>
                <input type="text" id="spotifyUrl" value="https://open.spotify.com">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="spotifyEnabled" checked> Enable Spotify
                </label>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>Xbox Cloud Gaming URL</label>
                <input type="text" id="xboxUrl" value="https://www.xbox.com/play">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="xboxEnabled" checked> Enable Xbox
                </label>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>Prime Video URL</label>
                <input type="text" id="primeUrl" value="https://www.primevideo.com">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="primeEnabled" checked> Enable Prime Video
                </label>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label>Google Photos URL</label>
                <input type="text" id="photosUrl" value="https://photos.google.com">
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="photosEnabled" checked> Enable Google Photos
                </label>
            </div>
        </div>
    </div>

    <div class="settings-section">
        <h2>üè† System</h2>
        <div class="form-group">
            <label>
                <input type="checkbox" id="kioskMode"> Enable Kiosk Mode
            </label>
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" id="autoStart"> Auto-start Browser
            </label>
        </div>
        <div class="form-group">
            <label>Display Timeout (minutes)</label>
            <select id="displayTimeout">
                <option value="0">Never</option>
                <option value="5">5 minutes</option>
                <option value="10">10 minutes</option>
                <option value="30">30 minutes</option>
                <option value="60">1 hour</option>
            </select>
        </div>
    </div>

    <div style="margin-top: 30px;">
        <button class="btn" onclick="saveSettings()">Save Settings</button>
        <button class="btn btn-secondary" onclick="testSettings()">Test Connection</button>
    </div>

    <script>
        let currentSettings = {};

        window.onload = function() {
            loadSettings();
        };

        function loadSettings() {
            fetch('/api/settings')
                .then(r => r.json())
                .then(settings => {
                    currentSettings = settings;
                    console.log('Loaded settings:', settings);
                    
                    // Voice settings
                    document.getElementById('voiceProvider').value = settings.voice_provider || 'local';
                    document.getElementById('wakeWords').value = (settings.wake_words || ['hey bing', 'okay bing']).join(', ');
                    document.getElementById('voiceEnabled').checked = settings.voice_enabled !== false;
                    
                    // Weather settings
                    document.getElementById('weatherSource').value = settings.weather_source || 'openweather';
                    document.getElementById('weatherLocation').value = settings.weather_location || 'Gold Coast, QLD';
                    updateWeatherSourceInfo();
                    
                    // API Keys - Show status if configured
                    if (settings.openai_api_key_configured || settings.openai_api_key) {
                        document.getElementById('openaiStatus').textContent = '(configured)';
                    }
                    
                    if (settings.weather_api_key_configured || settings.weather_api_key) {
                        document.getElementById('weatherApiStatus').textContent = '(configured)';
                    }
                    
                    if (settings.bing_api_key_configured || settings.bing_api_key) {
                        document.getElementById('bingStatus').textContent = '(configured)';
                    }
                    
                    if (settings.home_assistant_token_configured || settings.home_assistant_token) {
                        document.getElementById('haStatus').textContent = '(configured)';
                    }
                    
                    // Home Assistant URL
                    document.getElementById('haUrl').value = settings.home_assistant_url || 'http://localhost:8123';
                    
                    // Apps settings
                    if (settings.apps) {
                        document.getElementById('netflixUrl').value = settings.apps.netflix?.url || 'https://www.netflix.com';
                        document.getElementById('netflixEnabled').checked = settings.apps.netflix?.enabled !== false;
                        
                        document.getElementById('youtubeUrl').value = settings.apps.youtube?.url || 'https://www.youtube.com/tv';
                        document.getElementById('youtubeEnabled').checked = settings.apps.youtube?.enabled !== false;
                        
                        document.getElementById('spotifyUrl').value = settings.apps.spotify?.url || 'https://open.spotify.com';
                        document.getElementById('spotifyEnabled').checked = settings.apps.spotify?.enabled !== false;
                        
                        document.getElementById('xboxUrl').value = settings.apps.xbox_cloud?.url || 'https://www.xbox.com/play';
                        document.getElementById('xboxEnabled').checked = settings.apps.xbox_cloud?.enabled !== false;
                        
                        document.getElementById('primeUrl').value = settings.apps.prime_video?.url || 'https://www.primevideo.com';
                        document.getElementById('primeEnabled').checked = settings.apps.prime_video?.enabled !== false;
                        
                        document.getElementById('photosUrl').value = settings.apps.google_photos?.url || 'https://photos.google.com';
                        document.getElementById('photosEnabled').checked = settings.apps.google_photos?.enabled !== false;
                    }
                    
                    // System settings
                    document.getElementById('kioskMode').checked = settings.kiosk_mode || false;
                    document.getElementById('autoStart').checked = settings.auto_start_browser || false;
                    document.getElementById('displayTimeout').value = settings.display_timeout || '0';
                })
                .catch(err => {
                    console.error('Error loading settings:', err);
                    showMessage('Error loading settings', 'error');
                });
        }

        function updateWeatherSourceInfo() {
            const source = document.getElementById('weatherSource').value;
            const infoEl = document.getElementById('weatherSourceInfo');
            const locationGroup = document.getElementById('weatherLocationGroup');
            const apiGroup = document.getElementById('weatherApiGroup');
            
            switch(source) {
                case 'openweather':
                    infoEl.innerHTML = 'üåç Global weather data with detailed forecasts. Requires free API key.';
                    locationGroup.style.display = 'block';
                    apiGroup.style.display = 'block';
                    break;
                case 'qld_radar':
                    infoEl.innerHTML = 'üá¶üá∫ Queensland-specific radar with live precipitation data. No API key required.';
                    locationGroup.style.display = 'none';
                    apiGroup.style.display = 'none';
                    break;
                case 'bom_australia':
                    infoEl.innerHTML = 'üá¶üá∫ Australian Bureau of Meteorology data. No API key required.';
                    locationGroup.style.display = 'block';
                    apiGroup.style.display = 'none';
                    break;
            }
        }

        function testWeatherConfig() {
            const source = document.getElementById('weatherSource').value;
            const location = document.getElementById('weatherLocation').value;
            const apiKey = document.getElementById('weatherApiKey').value;
            
            showMessage('Testing weather configuration...', 'success');
            
            // Create test settings
            const testSettings = {
                weather_source: source,
                weather_location: location
            };
            
            if (apiKey) {
                testSettings.weather_api_key = apiKey;
            }
            
            fetch('/api/weather/test', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(testSettings)
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('weatherPreview').style.display = 'block';
                    document.getElementById('weatherPreviewContent').innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 24px; font-weight: bold;">${data.current.temp}¬∞C</div>
                                <div>${data.current.description}</div>
                                <div style="font-size: 12px; opacity: 0.7;">${data.current.location}</div>
                            </div>
                            <div style="text-align: right;">
                                <div>üíß ${data.current.humidity}%</div>
                                <div>üå™Ô∏è ${data.current.wind_speed} km/h</div>
                                ${data.current.radar_available ? '<div>üì° Radar Available</div>' : ''}
                            </div>
                        </div>
                    `;
                    showMessage('Weather test successful!', 'success');
                } else {
                    showMessage('Weather test failed: ' + (data.error || 'Unknown error'), 'error');
                    document.getElementById('weatherPreview').style.display = 'none';
                }
            })
            .catch(err => {
                showMessage('Weather test failed', 'error');
                document.getElementById('weatherPreview').style.display = 'none';
            });
        }

        function saveSettings() {
            const settings = {
                // Voice settings
                voice_provider: document.getElementById('voiceProvider').value,
                wake_words: document.getElementById('wakeWords').value.split(',').map(w => w.trim()),
                voice_enabled: document.getElementById('voiceEnabled').checked,
                
                // Weather settings
                weather_source: document.getElementById('weatherSource').value,
                weather_location: document.getElementById('weatherLocation').value,
                
                // Home Assistant
                home_assistant_url: document.getElementById('haUrl').value,
                
                // System settings
                kiosk_mode: document.getElementById('kioskMode').checked,
                auto_start_browser: document.getElementById('autoStart').checked,
                display_timeout: parseInt(document.getElementById('displayTimeout').value),
                
                // Apps
                apps: {
                    netflix: {
                        url: document.getElementById('netflixUrl').value,
                        enabled: document.getElementById('netflixEnabled').checked
                    },
                    youtube: {
                        url: document.getElementById('youtubeUrl').value,
                        enabled: document.getElementById('youtubeEnabled').checked
                    },
                    spotify: {
                        url: document.getElementById('spotifyUrl').value,
                        enabled: document.getElementById('spotifyEnabled').checked
                    },
                    xbox_cloud: {
                        url: document.getElementById('xboxUrl').value,
                        enabled: document.getElementById('xboxEnabled').checked
                    },
                    prime_video: {
                        url: document.getElementById('primeUrl').value,
                        enabled: document.getElementById('primeEnabled').checked
                    },
                    google_photos: {
                        url: document.getElementById('photosUrl').value,
                        enabled: document.getElementById('photosEnabled').checked
                    }
                }
            };
            
            // Only update API keys if new values are entered
            const openaiKey = document.getElementById('openaiKey').value;
            if (openaiKey && openaiKey !== '') {
                settings.openai_api_key = openaiKey;
            }
            
            const weatherKey = document.getElementById('weatherApiKey').value;
            if (weatherKey && weatherKey !== '') {
                settings.weather_api_key = weatherKey;
            }
            
            const bingKey = document.getElementById('bingKey').value;
            if (bingKey && bingKey !== '') {
                settings.bing_api_key = bingKey;
            }
            
            const haToken = document.getElementById('haToken').value;
            if (haToken && haToken !== '') {
                settings.home_assistant_token = haToken;
            }

            console.log('Saving settings:', settings);

            fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(settings)
            })
            .then(r => r.json())
            .then(data => {
                console.log('Save response:', data);
                if (data.success) {
                    showMessage('Settings saved successfully!', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showMessage('Error: ' + (data.error || 'Failed to save'), 'error');
                }
            })
            .catch(err => {
                console.error('Save error:', err);
                showMessage('Error saving settings', 'error');
            });
        }

        function showMessage(message, type) {
            const messageDiv = document.getElementById('statusMessage');
            messageDiv.textContent = message;
            messageDiv.className = 'status-message show ' + type;
            
            setTimeout(() => {
                messageDiv.className = 'status-message';
            }, 5000);
        }

        function checkHealth() {
            fetch('/api/health')
                .then(r => r.json())
                .then(data => {
                    showMessage('System Status: ' + data.status + ' | Version: ' + (data.version || '2.1.0'), 'success');
                })
                .catch(err => showMessage('Health check failed', 'error'));
        }

        function restartSystem() {
            if (confirm('Restart BingHome system?')) {
                fetch('/api/restart', {method: 'POST'})
                    .then(r => r.json())
                    .then(data => showMessage(data.message || 'Restarting...', 'success'))
                    .catch(err => showMessage('Restart failed', 'error'));
            }
        }

        function testSettings() {
            checkHealth();
            testWeatherConfig();
        }
    </script>
</body>
</html>
